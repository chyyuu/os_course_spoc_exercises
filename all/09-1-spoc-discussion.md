# 文件系统(lec 21) spoc 思考题

## 个人思考题
### 文件系统和文件 
 1. 文件系统的功能是什么？

>  负责数据持久保存，功能是数据存储和访问

>  具体功能：文件分配、文件管理、数据可靠和安全

 1. 什么是文件？

>  文件系统中具有符号名的基本数据单位。

重要区别：每个文件有个名字

还关心：时间信息 内容信息 版本信息等等

### 文件描述符
 1. 打开文件时，文件系统要维护哪些信息？

>  文件指针、打开文件计数、访问权限、文件位置和数据缓存

 1. 文件系统的基本数据访问单位是什么？这对文件系统有什么影响？
 
 os：基本单位是文件 磁盘读写的最小单位：数据块
 数据库：也还不一样
 
 1. 文件的索引访问有什么特点？如何优化索引访问的速度？

### 目录、文件别名和文件系统种类
 1. 什么是目录？

>  由文件索引项组成的特殊文件。

 1. 目录的组织结构是什么样的？

>  树结构、有向图

 1. 目录操作有哪些种类？
 1. 什么是文件别名？软链接和硬链接有什么区别？
 1. 路径遍历的流程是什么样的？如何优化路径遍历？
 1. 什么是文件挂载？
 
 1. 为什么会存在大量的文件类型？

光盘：一次写多次读  按连续存储来进行，读速度快
磁盘：多次写多次读 

多种文件系统出现的原因：磁盘容量的变化 安全性 容错机制

### 虚拟文件系统 
 1. 虚拟文件系统的功能是什么？

>  对上对下的接口、高效访问实现

 1. 文件卷控制块、文件控制块和目录项的相互关系是什么？
 1. 可以把文件控制块放到目录项中吗？这样做有什么优缺点？


### 文件缓存和打开文件
 1. 文件缓存和页缓存有什么区别和联系？
 1. 为什么要同时维护进程的打开文件表和操作系统的打开文件表？这两个打开文件表有什么区别和联系？为什么没有线程的打开文件表？
 
 进程表为了自己维护信息
 
 系统表是为了支持共享，如果两个进程读同一个文件，可以缓存，这个就有操作系统控制
 
 
 
### 文件分配
 1. 文件分配的三种方式是如何组织文件数据块的？各有什么特征？
 1. UFS多级索引分配是如何组织文件数据块的位置信息的？

### 空闲空间管理和冗余磁盘阵列RAID
 1. 硬盘空闲空间组织和文件分配有什么异同？
 1. RAID-0、1、4和5分别是如何组织磁盘数据块的？各有什么特征？

## 小组思考题
 1. (spoc)完成Simple File System的功能，支持应用程序的一般文件操作。具体帮助和要求信息请看[sfs-homework](https://github.com/chyyuu/ucore_lab/blob/master/related_info/lab8/sfs-homework.md)

问题1：见本目录下lab8-spoc-discuss/sfs_states.txt

问题2：见本目录下lab8-spoc-discuss/sfs.py

问题3：见本目录下lab8-spoc-discuss/sfs.py

对问题3，软连接，创建连接时，在parent目录下新建一个文件，然后将链向的文件的inode位置写到这个新建的文件中以实现软连接。由于python文件封装得太严密囧 直接使用原来的测力，将原来的硬链接函数替换为软连接函数。运行输出如下：

    link("/u", "/x");

    inode bitmap  11111000
    inodes        [d a:0 r:5] [d a:1 r:2] [f a:-1 r:1] [f a:-1 r:1] [f a:2 r:1] [] [] [] 
    data bitmap   11100000
    data          [(.,0) (..,0) (g,1) (q,2) (u,3) (x,4)] [(.,1) (..,0)] [3] [] [] [] [] [] 
    
    mkdir("/t");
    
    inode bitmap  11111100
    inodes        [d a:0 r:6] [d a:1 r:2] [f a:-1 r:1] [f a:-1 r:1] [f a:2 r:1] [d a:3 r:2] [] [] 
    data bitmap   11110000
    data          [(.,0) (..,0) (g,1) (q,2) (u,3) (x,4) (t,5)] [(.,1) (..,0)] [3] [(.,5) (..,0)] [] [] [] [] 

 1. (spoc)FAT、UFS、YAFFS、NTFS这几种文件系统中选一种，分析它的文件卷结构、目录结构、文件分配方式，以及它的变种。
  wikipedia上的文件系统列表参考
  - http://en.wikipedia.org/wiki/List_of_file_systems
  - http://en.wikipedia.org/wiki/File_system
  - http://en.wikipedia.org/wiki/List_of_file_systems
  
  NTFS：

文件分配方式：链式分配，以簇的形式分配，最小单位多扇区，N个扇区为一簇，簇大小一般为4KB，即8个扇区。使用逻辑簇号与虚拟簇号相结合的方式，逻辑簇号以卷为单位。映射时，通过簇大小与逻辑簇号的乘积得到卷地址。虚拟簇号是对用户文件而言的，指对该文件使用的簇号进行编号，如果知道了文件的开始地址，就可以用虚拟簇号映射到逻辑簇号得到地址。

文件卷结构与目录结构：

NTFS的数据可以分为四个部分：

(1)引导扇区BPB。大小为一个扇区

(2) 系统文件，NTFS一共有16个系统文件和8个保留文件

(3) File area数据区，六个用户的空间。

(4)MFT主文件表。这是NFTS的核心，用来存放所有文件的各种信息以及未分配空间的信息，每个文件都对应一个纪录项。每个记录项为每一个文件保存了一组不同的属性，不同的属性存储了文件不同的信息，甚至数据也是作为“data”属性存在的。MFT本身也有也有自己的记录项，每个MST表项大概1KB大小，对于元数据而言，如果能记录全部信息，就保存在MST中；如果不能，就保存在对应文件的簇中。FAT里目录包含了其下文件的所有额外信息，文件本身只包含数据。而在NTFS里，文件就是属性的集合，会自己包含需要的描述信息和数据。目录同样只包含自己的信息，而不用管其下的文件。MFT自身是一个文件，其第一个记录是它自身。每个记录都有一个ID，MFT和其他23个文件一起组成元文件。用户文件ID从24开始，没添加一个文件ID加一。元文件/ID及对应的功能如下：

    序号（ID）                                  元文件                                                                                       功能   
    0                                                      $MFT                                                                              主文件列表本身   
    1                                                      $MFTMirr                                                                     主文件表的部分镜像   
    2                                                      $LogFile                                                                           日志文件   
    3                                                      $Volume                                                                               卷文件   
    4                                                     $AttrDef                                                                            属性定义列表   
    
    5                                                     $Root                                                                                根目录   
    6                                                     $Bitmap                                                                             位图文件   
    7                                                      $Boot                                                                               引导文件   
    8                                                     $BadClus                                                                           坏簇文件   
    9                                                      $Secure                                                                            安全文件   
    10                                                   $UpCase                                                                          大写文件   
    11-15                                              $Extend                                                                            扩展文件（一共5个文件）   
    16-23                                               保留  

其中，$Volume起到了文件卷的作用，其中记录了卷的相关信息，如卷对象标识符、卷标、文件系统版本，以及若干卷标志（包括：“正在加载”、“需要扫描”、“需要调整 $LogFile 大小”、“在 NT4 上加载”、“正在更新卷序列号”、“需要升级结构”等）。卷序列号储存在 $Boot 文件中。

NTFS的优缺点：

优点：因为表项为2的32次方，所以当容量扩大时，依然可以使用较小的簇（一般最佳为4KB）防止簇内碎片的增加。

缺点：兼容性较差，不能向下兼容
  

  

  请同学们依据自己的选择，在下面链接处回复分析结果。
  - [https://piazza.com/class/i5j09fnsl7k5x0?cid=416 FAT文件系统分析]
  - [https://piazza.com/class/i5j09fnsl7k5x0?cid=417 NTFS文件系统分析]
  - [https://piazza.com/class/i5j09fnsl7k5x0?cid=418 UFS文件系统分析]
  - [https://piazza.com/class/i5j09fnsl7k5x0?cid=419 ZFS文件系统分析]
  - [https://piazza.com/class/i5j09fnsl7k5x0?cid=420 YAFFS文件系统分析]
