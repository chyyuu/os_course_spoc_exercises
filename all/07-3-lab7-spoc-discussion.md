# 同步互斥(lec 19 lab7) spoc 思考题


- 有"spoc"标记的题是要求拿清华学分的同学要在实体课上完成，并按时提交到学生对应的ucore_code和os_exercises的git repo上。

## 个人思考题

### 19.1 总体介绍

1. 同步机制、处理机调度、等待队列和定时器有些什么相互影响？

 > 底层支持：中断禁止、定时器、等待队列
 
 > 同步机制：信号量、管程（条件变量）

 > 同步管理：处理机调度

### 19.2 底层支撑

1. 操作系统内核如何利用定时器实现sleep系统？在定时队列中保存的时间格式是什么？

 > 定时器的数据结构、定时器的设置函数do_sleep()、定时器的触发流程

2. 中断屏蔽控制位在哪个寄存器中？如何修改中断屏蔽控制位？

 > 屏蔽中断指令：STI、CLI

3. 在ucore中有多少种等待队列？
4. 等待队列的两个基本操作down()和up()对线程状态和等待队列有什么影响？

 > 等待队列的数据结构、等待队列操作（等待、唤醒）

### 19.3 信号量设计实现

1. ucore中的信号量实现能实现是按FIFO获取信号量资源吗？给出你的理由。
2. ucore中的信号量实现用到自旋锁(spinlock)吗？为什么？
3. 为什么down()要加一个_down()函数来进行实质的处理？类似情况还出现在up()和_up()。

> 参考回答：有多个有小差异的类似函数要使用相同的核心功能实现。类似情况还出现在do_fork()函数。

### 19.4 管程和条件变量设计实现

1. 管程与信号量是等价的。如何理解？
 - 基于信号量的管程中在什么地方用到信号量？
 - 管程实现中的monitor.next的作用是什么？
 - 分析管程实现中PV操作的配对关系，并解释PV操作的目的。
 - 基于视频中对管程的17个状态或操作的分析，尝试分析管程在入口队列和条件变量等待队列间的等待和唤醒关系。注意分析各队列在什么情况下会有线程进入等待，在什么时候会被唤醒，以及这个等待和唤醒的依赖关系。

### 19.5 哲学家就餐问题

1. 哲学家就餐问题的管程实现中的外部操作成员函数有哪几个？
 - 哲学家就餐问题的管程实现中用了几个条件变量？每个条件变量的作用是什么？
 
## 小组思考题

1. (扩展练习) 每人用ucore中的信号量和条件变量两种手段分别实现40个同步问题中的一题。向勇老师的班级从前往后，陈渝老师的班级从后往前。请先理解与采用python threading 机制实现的异同点。

2. （扩展练习）请在lab7-answer中分析
  -  cvp->count含义是什么？cvp->count是否可能<0, 是否可能>1？请举例或说明原因。
     
     cvp->count含义是等待条件变量cvp的进程/线程数目。
     cvp->count不可能小于零，因为所有cvp->count的增加都在对应的减少操作之前，而程序执行的顺序是固定的，与同步互斥无关。
     cvp->count可能大于1，如多个进程等待同一个信号量。
  -  cvp->owner->next_count含义是什么？cvp->owner->next_count是否可能<0, 是否可能>1？请举例或说明原因。
 
     cvp->owner->next_count含义是发出条件变量cvp的signal的正在等待的进程/线程数目。
     cvp->owner->next_count不可能小于0，因为所有cvp->owner->next_count的增加都在对应的减少操作之前，而程序执行的顺序是固定的，与同步互斥无关。
     cvp->owner->next_count不可能大于1，因为next_count的增加是在cond_signal过程中；而某一个cond_signal过程在执行期间将全程持有互斥锁mt.mutex（该互斥锁会短暂传递给某一个cond_wait进程，然后再返还回来，在此过程中因为没有方法获取互斥锁mt.mutex，所以不可能有第二个进程/线程调用cond_signal）。故cvp->owner->next_count的增加与减少将配套执行。
  -  目前的lab7-answer中管程的实现是Hansen管程类型还是Hoare管程类型？请在lab7-answer中实现另外一种类型的管程。
     
     目前的lab7-answer中管程的实现是Hoare管程类型。
